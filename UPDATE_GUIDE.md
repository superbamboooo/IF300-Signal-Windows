# IF300 数据更新指南

## 快速开始

### 更新数据

1. **打开 IF300 应用**
2. **点击"更新数据"按钮**
3. **等待更新完成**（通常需要3-5秒）
4. **查看反馈信息**（含数据源说明）

---

## 新增功能：多源数据验证

从最新版本开始，数据更新采用**多源验证机制**。

### 工作原理

```
手动更新 → 并行查询3个数据源 → 自动验证数据一致性 → 详细反馈源信息
```

### 数据源

| 名称 | 类型 | 状态 | 用途 |
|------|------|------|------|
| 新浪财经 | 实时 + 日K线 | 首选 | 主要数据源 |
| 东方财富 | 实时 | 备用 | 验证和交叉确认 |
| 和讯期货 | 实时 | 应急 | 多源都失败时使用 |

---

## 反馈信息说明

### 正常反馈示例

```
✓ 数据更新成功
合约: IF2603
最新价: 4731.2
获取时间: 14:45:17

【数据来源验证】
  ✓ 新浪季月: 成功 (4731.2)
  ✓ 东方财富季月: 成功 (4731.2)
  ✗ 和讯季月: 无数据

✓ 多源验证: 2个数据源都已确认
✓ 数据一致（多源最大价差: 0点）
→ 本次使用数据源: 新浪(IF2603)
```

**含义:**
- 两个主要数据源都成功获取数据
- 两个源的价格完全一致（0点差）
- 数据可信度最高 ✓

### 部分源失败（正常）

```
✓ 数据更新成功
合约: IF2603
最新价: 4731.2
获取时间: 14:45:17

【数据来源验证】
  ✓ 新浪季月: 成功 (4731.2)
  ✗ 东方财富季月: 无数据
  ✗ 和讯季月: 无数据

→ 本次使用数据源: 新浪(IF2603)
```

**含义:**
- 新浪源成功，其他源临时不可用
- 这是正常现象，不影响数据使用
- 系统已自动切换到最可靠的源

### 多源价格差异（盘中）

```
【数据来源验证】
  ✓ 新浪季月: 成功 (4731.2)
  ✓ 东方财富季月: 成功 (4731.5)
  ✗ 和讯季月: 无数据

✓ 多源验证: 2个数据源都已确认
⚠ 数据差异1点（可能因盘中时间差）
（最大价差: 1点）
```

**含义:**
- 两个源数据差异为1点（正常范围）
- 原因：盘中获取的时间相差1-2秒
- 这个差异不影响策略决策，可以放心使用

---

## 最佳实践

### ✓ 推荐做法

1. **交易日下午15:00后更新**（日线数据最完整）
   ```
   每个交易日 15:05 左右更新一次
   ```

2. **交易前检查**（确保有最新信号）
   ```
   早上开市前 9:20 检查一次
   下午开市前 12:50 检查一次
   ```

3. **盘中参考**（允许±1点差异）
   ```
   看反馈信息的数据源
   选择多源都确认的价格
   ```

### ✗ 避免做法

- ❌ 频繁刷新（10秒内多次）：没有意义，浪费网络
- ❌ 午间休市更新：行情可能延迟，不准确
- ❌ 不同时刻数据对比：盘中会有时间差异，无法直接对比

---

## 故障排查

### 问题 1: 所有数据源都失败

```
✗ 获取实时行情失败，数据保持不变，最新日期: 2026-01-23
```

**原因和解决:**
| 原因 | 检查方法 | 解决方案 |
|------|---------|---------|
| 网络故障 | 打开浏览器访问新浪财经 | 检查WiFi/网络连接 |
| 股指期货休市 | 查看交易日历 | 周末或节假日，稍后重试 |
| 防火墙阻止 | 查看网络设置 | 调整防火墙规则 |

**解决步骤:**
1. 检查网络连接（ping sina.com.cn）
2. 稍等2-3分钟后重试
3. 如果还是失败，说明确实是网络问题，不影响使用

### 问题 2: 数据价差超过1点

```
⚠ 数据差异 3点（可能因盘中时间差）
```

**可能原因:**
- 盤中成交量大，价格波动快
- 数据源获取时刻相差3-5秒
- 可能某个源数据有延迟

**处理方案:**
- 再次点击"更新数据"刷新
- 或查看多个源，选择最权威的（新浪）
- 如果差异持续>2点，说明可能有数据异常，联系管理员

### 问题 3: 显示"前一交易日数据修正"

```
已修正2026-01-23数据: 收盘:4725.6→4726.0, 成交量:45000→48000
```

**含义:**
- 系统发现历史数据有缺失或不完整
- 从新API获取了完整数据并自动修正
- ✓ 这是正常的维护行为

---

## 常见问题

### Q1: 为什么有时显示"无数据"？

**A:** 可能是这个数据源服务器暂时故障或延迟。系统已自动使用其他源。不影响数据使用。

### Q2: 盘中价格和网页看的不一样？

**A:** 可能原因：
- 获取时刻不同（相差几秒）
- 如果差异<1点，完全正常
- 建议以多源都确认的价格为准

### Q3: 应该多久更新一次？

**A:**
- **日常**: 每个交易日1-2次（下午15:00后和早上开市前）
- **关键时刻**: 要做交易前更新一次确认信号
- **非交易日**: 不需要更新

### Q4: 本地数据和网络数据哪个准？

**A:**
- **本地CSV**: 存储历史K线数据，用于计算信号
- **网络实时**: 获取当日实时价格进行修正
- 二者配合使用最准确

---

## 技术说明

### 数据流向

```
网络数据源
   ↓
【并行查询】
   ├─ 新浪: 获取实时行情 + 前一交易日K线
   ├─ 东方财富: 获取实时行情
   └─ 和讯: 获取实时行情（应急）
   ↓
【验证和一致性检查】
   ├─ 对比多源价格
   ├─ 检查价差（±1点内正常）
   └─ 选择最可靠源
   ↓
【数据修正】
   ├─ 修正前一交易日的OHLCV
   └─ 添加当日实时行情
   ↓
本地CSV文件
   ↓
IF300策略（计算信号）
```

### 数据验证逻辑

```python
if 数据来自多个源:
    计算最大价差 = max(源1, 源2, 源3) - min(源1, 源2, 源3)
    if 最大价差 <= 1点:
        状态 = "✓ 数据一致"
    else:
        状态 = "⚠ 数据差异(可能因盘中时间差)"
else:
    状态 = "✓ 单源确认（其他源不可用）"
```

---

## 更新日志

### v1.1 (2026-01-26)

**新增:**
- ✨ 多源并行查询机制
- ✨ 自动数据一致性验证
- ✨ 详细的数据源信息反馈
- ✨ 前一交易日K线数据修正

**改进:**
- 📈 从AKShare切换到直接API（更稳定）
- 📈 改进反馈信息的可读性
- 📈 增加盘中价差容差处理

**文档:**
- 📚 添加完整的数据源说明文档
- 📚 添加故障排查指南

