# IF300 数据源说明

## 概述

IF300 策略的数据更新采用**多源验证**机制，确保数据准确性和完整性。

---

## 1. 数据源配置

### 当前支持的免费数据源

| 序号 | 数据源 | 覆盖范围 | 优先级 | 备注 |
|------|--------|---------|--------|------|
| 1 | 新浪财经 (Sina) | 实时行情 + 日K线 | ⭐⭐⭐ | 最稳定，更新最及时 |
| 2 | 东方财富 (Eastmoney) | 实时行情 | ⭐⭐ | 备用，偶尔延迟 |
| 3 | 和讯期货 (Hexun) | 实时行情 | ⭐ | 应急备用 |

### 数据类型

- **实时行情**: 当前价格、时间、开高低收、成交量、持仓量
- **日K线**: 前一交易日的完整OHLCV数据（用于修正不完整的日线数据）
- **本地历史数据**: CSV文件（`IF_主连_季月合约连接_day.csv`）

---

## 2. 工作流程

### 手动更新流程

点击"更新数据"按钮时的操作顺序：

```
1. 检查本地数据文件是否存在
   ├─ 读取现有数据
   └─ 确定最新数据日期

2. 【并行查询多数据源】
   ├─ 新浪财经: 获取实时行情 + 前一交易日K线
   ├─ 东方财富: 获取实时行情
   └─ 和讯期货: 获取实时行情（应急）

3. 【数据验证和一致性检查】
   ├─ 对比多源的实时价格
   ├─ 检查价格差异（盘中时间差±1点内为正常）
   └─ 显示所有数据源的状态

4. 【修正历史数据】
   ├─ 优先使用日K线修正前一交易日的OHLCV
   └─ 备用：仅修正昨收价

5. 【更新当日数据】
   └─ 如果是交易日，添加当天的实时行情

6. 【保存并反馈】
   ├─ 保存到本地CSV
   └─ 详细反馈数据来源信息
```

---

## 3. 盘中更新的处理

### 盘中时间差异说明

由于不同数据源的更新时间略有差异，盘中查询可能出现：

- **价格差异**: ±1点以内（正常范围）
- **时间不同步**: 各源获取时间相差几秒钟

**这些差异属于正常现象，不影响策略使用。**

### 何时更新效果最好

| 时间段 | 建议 | 原因 |
|--------|------|------|
| 9:30-11:30 | ✓ 可以 | 上午交易时段，实时行情最准确 |
| 11:30-13:00 | ⚠ 谨慎 | 午间休市，行情更新可能延迟 |
| 13:00-15:00 | ✓ 可以 | 下午交易时段，实时行情最准确 |
| 15:00 之后 | ✓ 最佳 | 日线数据已更新完成，数据最完整 |
| 周末/节假日 | ✗ 不需要 | 非交易日，本地数据已保留 |

---

## 4. 数据反馈说明

### 成功更新的反馈格式

```
✓ 数据更新成功
合约: IF2603
最新价: 4750.5
获取时间: 14:30:25

【数据来源验证】
  新浪季月: 成功(4750.5)
  东方财富季月: 成功(4750.5)
  和讯季月: 成功

✓ 数据一致（多源最大价差: 0点）
本次使用数据源: 新浪(IF2603)
```

### 常见反馈说明

| 反馈内容 | 含义 | 处理方式 |
|---------|------|---------|
| ✓ 数据一致 | 多个源的数据完全相同 | 放心使用，数据最可靠 |
| ⚠ 数据差异1点 | 盘中时间差造成 | 可以接受，继续使用 |
| ✗ 获取实时行情失败 | 所有源都无法连接 | 稍后重试，或检查网络 |

---

## 5. 常见问题

### Q: 盘中价格和实时不一样，是不是数据错了？

**A:** 不一定。如果差异在1点以内，属于正常现象，原因是：
- 不同数据源的更新延迟（0-3秒）
- 刷新按钮点击的精确时间差
- 建议在15:00后更新以获得完整的日K线数据

### Q: 为什么有时候显示"某某源失败"？

**A:** 这是正常的，原因可能是：
- 该源服务器临时故障
- 网络延迟或超时
- 系统会自动尝试其他源，保证数据获取

### Q: 应该什么时候更新数据？

**A:**
- **日常**：每个交易日下午15:00后更新一次（获得完整的日K线数据）
- **关键时刻**：交易前检查一次确保最新信号
- **非交易日**：不需要更新，系统会保留历史数据

### Q: 本地CSV数据从哪来？

**A:**
- 初始数据来自历史记录（从2017年开始）
- 通过手动点击"更新数据"逐日增量更新
- 支持AKShare或新浪API获取历史数据

---

## 6. 数据来源详情

### 新浪财经 (Sina)

- **URL**: `https://hq.sinajs.cn/list=nf_{contract}`
- **特点**:
  - 国内期货数据最权威
  - 更新最及时（交易时段秒级更新）
  - 提供完整的日K线数据
- **可靠性**: ⭐⭐⭐⭐⭐

### 东方财富 (Eastmoney)

- **URL**: `https://futsseapi.eastmoney.com/api/qt/slist/get`
- **特点**:
  - 备用数据源
  - 偶尔更新延迟1-3秒
- **可靠性**: ⭐⭐⭐⭐

### 和讯期货 (Hexun)

- **URL**: `http://webftcn.hermes.hexun.com/shf/kline`
- **特点**:
  - 应急备用源
  - 不提供实时高低价
  - 仅在前两个源都失败时使用
- **可靠性**: ⭐⭐⭐

---

## 7. 更新日志

**最近更新** (2026-01-26)

✓ 启用多源验证机制
✓ 添加数据一致性检查
✓ 改进反馈信息详细度
✓ 支持盘中价格差异容差
✓ 添加前一交易日K线修正功能

